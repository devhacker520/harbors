var http = require("http");
var path = require("path");
var cluster = require("cluster");
var fs = require("fs");

var harbors = require("./harbors");
var _handle = require("./handle");

exports.createServer = function(){
    http.createServer(function(req, res){
        var define = harbors._config.admin.ip.some(function(a){
            if(req.connection.remoteAddress==a)
                return true;
        });
        if(!define){
            res.end("Access denied");
            return void 0;
        }
        var config = {
            dir:path.join(__dirname, '../admin/'),
            _module:0x0
        };
        var object = _handle(req, res, config);
        var realFile = path.join(config.dir, object._path.pathname);
        var extname = path.extname(object._path.pathname);
        if(extname!= '' && fs.existsSync(realFile)){
            object.display(realFile, true);
            return void 0;
        }
        try{
            if(!/\.(html|json)/.test(object._path.pathname)){
                object.display('../admin/index.html');
                return void 0;
            }
            require('../admin'+object._path.pathname)(object);
        }catch(err){
            console.log(err);
            object.notFound();
        }
    }).listen(8888);
};