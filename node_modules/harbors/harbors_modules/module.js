var harbors = require('./harbors');

exports.nodejs = function(object, realFile, rewrite){
    object._header['X-Powered-By'] = "nodejs/"+process.version;
    require('../nodejs/handle')(object, realFile, rewrite);
};

exports.php = function(object, realFile, rewrite){
    var dir = harbors.path.dirname(realFile);
    var file = harbors.path.basename(realFile);
    var FCGI_VERSION   = harbors.$fastcgi.constants.version;
    var FCGI_OFF       = harbors.$fastcgi.constants.keepalive.OFF;
    var FCGI_RESPONDER = harbors.$fastcgi.constants.role.FCGI_RESPONDER;
    var FCGI_BEGIN     = harbors.$fastcgi.constants.record.FCGI_BEGIN;
    var FCGI_STDIN     = harbors.$fastcgi.constants.record.FCGI_STDIN;
    var FCGI_STDOUT    = harbors.$fastcgi.constants.record.FCGI_STDOUT;
    var FCGI_PARAMS    = harbors.$fastcgi.constants.record.FCGI_PARAMS;
    var FCGI_END       = harbors.$fastcgi.constants.record.FCGI_END;

    var params = harbors.$utils.makeHeaders(object._headers, [
        ["SCRIPT_FILENAME", rewrite || realFile],
        ["QUERY_STRING", object._path.query||''],
        ["REQUEST_METHOD", object._method],
        ["SCRIPT_NAME", object._path.pathname],
        ["PATH_INFO", object._path.pathname],
        ["DOCUMENT_URI", object._path.path],
        ["REQUEST_URI", object._path.path],
        ["DOCUMENT_ROOT", dir],
        ["PHP_SELF", realFile],
        ["GATEWAY_PROTOCOL", "CGI/1.1"],
        ["SERVER_SOFTWARE", harbors.SERVER],

        ["SCRIPT_URL", object._path.pathname],
        ["SCRIPT_URI", "HTTP://"+object._headers.host+object._path.pathname],
        //["PATH", "C:\windows"]环境变量
        ["SERVER_NAME", object._headers.host],
        //["SERVER_ADDR", "127.0.0.1"]服务器ip
        //["SERVER_PORT", "80"]服务器端口
        //["REQUEST_SCHEME", "http"]
        ["REMOTE_PORT", object.request.client._peername.port.toString() || ""],//远程端口
        ["REMOTE_ADDR", object._ip]
    ]);

    var connection = new harbors.net.Stream();
    connection.setNoDelay(true);

    var writer = null;
    var parser = null;
    var header = {
        "version": FCGI_VERSION,
        "type": FCGI_BEGIN,
        "recordId": 0,
        "contentLength": 0,
        "paddingLength": 0
    };
    var begin = {
        "role": FCGI_RESPONDER,
        "flags": FCGI_OFF
    };
    var collectedStdin = [];
    var noMoreData = false;

    function endRequest() {
        if(writer) {
            header.type = FCGI_STDIN;
            header.contentLength = 0;
            header.paddingLength = 0;
            writer.writeHeader(header)
            connection.write(writer.tobuffer());
            connection.end();
        } else {
            noMoreData = true;
        }
    }

    function sendRequest (connection) {
        header.type = FCGI_BEGIN;
        header.contentLength = 8;
        writer.writeHeader(header);
        writer.writeBegin(begin);
        connection.write(writer.tobuffer());

        header.type = FCGI_PARAMS;
        header.contentLength = harbors.$fastcgi.getParamLength(params);
        writer.writeHeader(header);
        writer.writeParams(params);
        connection.write(writer.tobuffer());


        header.type = FCGI_PARAMS;
        header.contentLength = 0;
        writer.writeHeader(header);
        connection.write(writer.tobuffer());

        // header.type = FCGI_STDOUT;
        // writer.writeHeader(header);
        // connection.write(writer.tobuffer());

        if((object._method != 'PUT' && object._method != 'POST')) {
            endRequest()
        } else {
            for(var j = 0; j < collectedStdin.length; ++j) {
                header.type = FCGI_STDIN;
                header.contentLength = collectedStdin[j].length;
                header.paddingLength = 0;
                writer.writeHeader(header);
                writer.writeBody(collectedStdin[j]);
                connection.write(writer.tobuffer());
            }
            collectedStdin = [];
            if(noMoreData) {
                endRequest();
            }
        }
    };

    object.request.on('data', function(chunk) {
        if(writer) {
            header.type = FCGI_STDIN;
            header.contentLength = chunk.length;
            header.paddingLength = 0;
            writer.writeHeader(header);
            writer.writeBody(chunk);
            connection.write(writer.tobuffer())
        } else {
            collectedStdin.push(chunk);
        }
    });

    object.request.on('end', endRequest);

    connection.ondata = function (buffer, start, end) {
        parser.execute(buffer, start, end);
    };

    connection.addListener("connect", function() {
        writer = new harbors.$fastcgi.writer();
        parser = new harbors.$fastcgi.parser();

        writer.encoding = 'binary';

        var body="";

        parser.onRecord = function(record) {
            if (record.header.type == FCGI_STDOUT) {
                body += record.body;
            } else if(record.header.type == FCGI_STDOUT) {
                body += record.body;
            } else if(record.header.type == FCGI_END) {
                var parts = body.split("\r\n\r\n");

                var headers = parts.shift();
                var headerParts = headers.split("\r\n");

                body = parts.join("\r\n\r\n");

                var responseStatus = 200;

                headers = [];
                try {
                    for(var i in headerParts) {
                        header = headerParts[i].split(': ');
                        if (header[0].indexOf('Status') >= 0) {
                            responseStatus = header[1].substr(0, 3);
                            continue;
                        }

                        headers.push([header[0], header[1]]);
                    }
                } catch (err) {
                    //console.log(err);
                }


                if(responseStatus === "404") {
                    object.notFound();
                    parser.onRecord = function() {};
                    connection.end();
                    return void 0;
                }

                //写入头部缓存
                headers.map(function(a){
                    object._header[a[0]] = a[1];
                });
                object._statusCode = responseStatus;

                object.send(body)
            }
        };

        parser.onError = function(err) {
            //console.log(err);
        };

        sendRequest(connection);
    });

    connection.addListener("close", function() {
        connection.end();
    });

    connection.addListener("error", function(err) {
        harbors.sys.puts(harbors.sys.inspect(err.stack));
        connection.end();
    });
    var fcgi_host = harbors._config.vhost[object._num]['php']['fastcgi_host'];
    var fcgi_port = harbors._config.vhost[object._num]['php']['fastcgi_port'];

    connection.connect(fcgi_port, fcgi_host);
};