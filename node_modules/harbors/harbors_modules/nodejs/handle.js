var harbors = require("../harbors");

var path = require("path");

var _cookie = require("./cookie");
var _session = require("./session");
var _require = require("./require");
var _sync = require("../sync");
var _post = require("./post");
var _route = require("./route");

module.exports = function(object, realFile){
    object._header["X-Powered-By"] = "NODEJS/"+process.version

    //route参数
    object._route = object._path.pathname.split('/');
    object._route[0] == '' && object._route.shift();
    object.route = _route.handle;

    //cookie参数
    object._cookie = [];//cookie暂存对象
    object.__cookie = {};//解析后的cookie
    if(object.client.headers['cookie'] != void 0)
        object.__cookie = _cookie.load(object.client.headers['cookie']);
    object.cookie = _cookie.handle;
    //console.log(object.__cookie);

    //session参数
    object._session = {};//session暂存对象\解析后的session
    object.session = _session.handle;
    _session.load(object);

    //send方法开始执行前回调此函数
    object._resultsEnd = function(){
        //发送cookie
        object._header['Set-Cookie'] = object._cookie;
        //记录session
        _session.save(object);
    };

    object.sync = _sync;
    object.socket = require('./socket').handle;

    //接收post参数
    object.sync()
        .add(function(next){
            _post.handle(object, function(err, fields, files){
                object._post = fields;
                object._file = files;
                next();
            },next)
        })
        .end(function(){
            require(realFile)(object);
        });

    //清除编译缓存
    if(object._config.nodejs.autoReload){
        var dir = path.join(object._config.dir, '../');
        _require.clearCache(dir);
    }
};
