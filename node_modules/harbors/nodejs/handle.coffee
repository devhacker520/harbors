harbors = require('../harbors_modules/harbors')
session = require('./session');
cookie = require('./cookie');
post = require('./post');

module.exports = (object, file, rewrite) ->
  object._route = object._path.pathname.replace(/^\//,'').replace(/\/$/,'').split('/')
  object.session = session.handle
  object.cookie = cookie.handle
  object.date = harbors.$date
  object.sync = harbors.$sync
  object._cookie = []#cookie暂存对象
  object._session = {}#session暂存对象\解析后的session
  object.__cookie = []#解析后的cookie
  object.route = (num)->
    if typeof num == 'number'
      return object._route[num]
    else
      return object._route
  object._resultsEnd = ->
    #cookie
    object._header['Set-Cookie'] = object._cookie;
    #session
    session.save object;
    return;

  try
    #cookie整理
    if object._headers['cookie'] != undefined
      object.__cookie = cookie.load object._headers['cookie']
    else
      object.__cookie = {}
    #console.log object.__cookie
    #读取session
    sessionId = harbors._config.vhost[object._num]['nodejs']['session_id']
    if object.__cookie[sessionId]
      session.load object, object.__cookie[sessionId], harbors._config.vhost[object._num]['tmp_dir']
    #console.log(object._session)
    harbors.$sync('normal')
      .add (next) ->
        if object._method=="post"
          post.handle object, (err, fields, files) ->
            object._post = fields
            object._file = files
            next()
            return
        else
          next()
        return
      .end () ->
        handle = require file
        handle object
        return
  catch err
    console.log err
    object.error()
  return