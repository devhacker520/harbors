// Generated by CoffeeScript 1.6.3
(function() {
  var cookie, harbors, post, session;

  harbors = require('../harbors_modules/harbors');

  session = require('./session');

  cookie = require('./cookie');

  post = require('./post');

  module.exports = function(object, file, rewrite) {
    var err, sessionId;
    object._route = object._path.pathname.replace(/^\//, '').replace(/\/$/, '').split('/');
    object.session = session.handle;
    object.cookie = cookie.handle;
    object.date = harbors.$date;
    object.sync = harbors.$sync;
    object._cookie = [];
    object._session = {};
    object.__cookie = [];
    object.route = function(num) {
      if (typeof num === 'number') {
        return object._route[num];
      } else {
        return object._route;
      }
    };
    object._resultsEnd = function() {
      object._header['Set-Cookie'] = object._cookie;
      session.save(object);
    };
    try {
      if (object._headers['cookie'] !== void 0) {
        object.__cookie = cookie.load(object._headers['cookie']);
      } else {
        object.__cookie = {};
      }
      sessionId = harbors._config.vhost[object._num]['nodejs']['session_id'];
      if (object.__cookie[sessionId]) {
        session.load(object, object.__cookie[sessionId], harbors._config.vhost[object._num]['tmp_dir']);
      }
      harbors.$sync('normal').add(function(next) {
        if (object._method === "post") {
          post.handle(object, function(err, fields, files) {
            object._post = fields;
            object._file = files;
            next();
          });
        } else {
          next();
        }
      }).end(function() {
        var handle;
        handle = require(file);
        handle(object);
      });
    } catch (_error) {
      err = _error;
      console.log(err);
      object.error();
    }
  };

}).call(this);

/*
//@ sourceMappingURL=handle.map
*/
