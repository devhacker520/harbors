/**
 * 日志模块
 */
var path = require('path');
var $fs = require('../lib/file');
var date = require('../lib/date');

exports.log = function(obj){
    obj.type = 'log';
    process.send(JSON.stringify(obj));
};

exports.write = function(data){
    try{
        var today = date();
        var logC = today.format('Y-M-D h:m:s')+' '+data.ip+' '+data.host+data.url+' '+data.code+'  '+data.errmsg+'\r\n';

        //检测创建文件夹
        $fs.mkdir(data.dir);
        //读取文件夹内的日志文件
        var files = $fs.readDir(data.dir);
        //过滤无用的文件
        files = files.filter(function(a){
            if(/_\d+\.log/.test(a)) return a;
        });
        //空目录新建日志文件
        if(files.length==0){
            var name = today.format('Y-M-D')+'_1.log';
            $fs.writeFile(path.join(data.dir,name),logC);
            return;
        }
        //非空目录判断日志文件个数，日志大小
        files = files.sort();
        //获取最后一个日志文件
        files = files[files.length-1];
        var stat = $fs.stat(path.join(data.dir,files));
        if(stat.size>data.size*1024){//超出大小新建文件
            var name = files.replace(/_(\d+)\.log/,function(a){
                var num = a.substr(1,1);
                return '_'+(parseInt(num)+1)+'.log';
            });
            $fs.writeFile(path.join(data.dir,name),logC);
        }else{//追加log
            $fs.appendFile(path.join(data.dir,files),logC,'utf8',function(err){
                if(err){
                    console.log(err);
                }
            });
        }
    }catch(err){
        console.log(err);
    }
};