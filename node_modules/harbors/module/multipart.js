var _l_utils = require('../lib/utils');
var multiparty = require('multiparty');
var qs = require('qs');

module.exports = function(request,next){
    var limit = request.vhost.upload_size || 2048*1024;

    //已执行过，或为get请求，并且存在
    if (request._post){
        next();
        return undefined;
    }
    if(request.req.method == 'HEAD' || request.req.method == 'GET'){
        next();
        return undefined;
    }
    if(_l_utils.mime(request.req) != 'multipart/form-data'){
        next();
        return undefined;
    }
    request._post = {};
    request._files = {};

    var form = new multiparty.Form()
        , data = {}
        , files = {}
        , done;

    function ondata(name, val, data){
        if (Array.isArray(data[name])) {
            data[name].push(val);
        } else if (data[name]) {
            data[name] = [data[name], val];
        } else {
            data[name] = val;
        }
    }

    form.on('field', function(name, val){
        ondata(name, val, data);
    });

    form.on('file', function(name, val){
        val.name = val.originalFilename;
        val.type = val.headers['content-type'] || null;
        ondata(name, val, files);
    });

    form.on('error', function(err){
        console.log(err)
        request.error();
        done = true;
    });


    form.on('close', function(){
        if (done) return;
        try {
            request._post = qs.parse(data);
            request._files = qs.parse(files);
        } catch (err) {
            form.emit('error', err);
            return;
        }finally{
            next();
        }
    });


    form.parse(request.req);
};