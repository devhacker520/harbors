var path = require('path');

var $fs = require('../lib/file');

/**
 * 读取session
 *   file：判断文件存在，读取，然后判断过期时间与ip地址正确定，过期则删除session文件
 * @param request
 * @param next
 * @returns {undefined}
 */
exports.analysis = function(request,next){

    //解析cookie
    request.req.headers.cookie ?
        (function(){
            if(!request.req.headers.cookie){
                return {};
            }
            var temp = request.req.headers.cookie.split(";");
            var cookie = {};
            for(var i=0;i<temp.length;i++){
                var temp_2 = temp[i].split("=");
                temp_2[0] = temp_2[0].replace(/^\s*/,'');
                cookie[temp_2[0]] = temp_2[1];
            }
            request._cookie = cookie;
        })() :
        request._cookie = {};

    //判断是否需要解析session
    if(request.vhost.session=='false'){
        request._session = {};
        next();
        return undefined;
    }

    var sId = request.cookie(request.vhost.session_id);
    if(!sId){
        request._session = {};
        next();
        return undefined;
    }

    var pathDir = path.join(request.vhost.tmp_dir,'./session/');

    var file = path.join(pathDir,sId);

    var session = $fs.readJson(file);

    if(!session){
        request._session = {};
        next();
        return;
    }
    if(session.time-0>new Date()-0){//未过期
        if(session.ip==request.req.connection.remoteAddress)
            request._session = session.data;
        else
            request._session = {};
    }else{//过期，删除
        $fs.unlink(file);
        request._session = {};
    }
    next();
};

/**
 * 设置session
 *     存储在临时文件夹下，为每一个session创建一个对应的json文件
 *     json => {
 *       ip:创建此session的ip地址（绑定ip防止cookie冒充）
 *       time:此session的过期时间戳
 *       data:session主要内容
 *     }
 * @param arg
 * @param self
 */
exports.set = function(self){

    var pathDir = path.join(self.vhost.tmp_dir,'./session/');
    //console.log(pathDir)
    //检查文件夹
    if(self._sCookie){
        $fs.mkdir(pathDir);
        //console.log(path.join(pathDir,self._sCookie))
        $fs.writeJson(path.join(pathDir,self._sCookie),{
            ip:self.req.connection.remoteAddress,
            time:(new Date()-0)+parseInt(self.vhost.session_survavil),
            data:self._session
        });
    }

};

/**
 * 检查session文件是否超时，超时则删除文件
 */
exports.checkSession = function(){
    console.log(harbors.config)
};