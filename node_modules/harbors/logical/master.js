/**
 * 检查配置文件
 */
exports.checkConfig = function(){
    require('../library/checkConfig')();
};
var path = require('path');
var fs = require('fs');

/**
 * 开启子进程
 */
var cluster = require('cluster');
var Worker = function(){//创建工作进程
    var cp = cluster.fork();
    console.log('Start - The promoter of new process. clusterid:'+cp.workerID+'. pid:'+cp.process.pid);
    cp.on('exit', function(code, signal) {
        console.log('The child process an unexpected error. Code:'+code+'.');
        //重启worker（此时进程id会增加1，以示和原错误关闭进程区别）
        !cp.suicide && (console.log('Separation of new sub process process...'),setTimeout(Worker,2000));
    });
    cp.on('message', function(code, signal) {
        console.log(code)
    });
    cp.on('message', function(code, signal) {
        code==='workers' && (function(){
            var worker = [];
            for (var id in cluster.workers) {
                worker.push({
                    id:cluster.workers[id].workerID,
                    pid:cluster.workers[id].process.pid
                });
            }
            cp.send(worker);
        })();
        code==='create' && (function(){
            Worker();
        })();
        /^kill\d*?$/.test(code) && (function(){
            var id = code.replace('kill','');
            if(cluster.workers[id]) cluster.workers[id].kill();
        })();
    });
};
exports.createWorker = function(){
    console.log('Start - harbors Service process started,Listening port:'+harbors.config.listenPort+'.Open the process number:'+harbors.config.clusterNum);
    for(var i=0;i<harbors.config.clusterNum;i++){
        Worker();
    }
};

exports.argv = function(task){
    var argv = process.argv.splice(2)[0];//参数数组,只接受第一个传入的参数
    if(argv&&argv=='--init'){
        console.log('The initialization program...');
        var createFile = require('../library/createFile');

        return false;
    }
    task();
};

exports.net = function(){

};