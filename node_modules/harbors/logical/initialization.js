var cluster = require('cluster');
var util = require('util');
var general = require('./general');
var master = require('./master');
var worker = require('./worker');

var app = {
    cluster:function(){

        //通用
        app.general();

        if (cluster.isMaster) {

            //主进程
            app.master();

        }else{

            //子进程
            app.worker();

        }

    },
    general:function(){

        //初始化
        global.harbors = {};
        //载入工具
        harbors.utils = require('../library/utils');
        //合并配置文件
        general.mergeConfig();
        //调试模式配置
        if(harbors.config.debug){
            harbors.log = util.log;
        }else{
            harbors.log = function(){};
        }

    },
    master:function(){

        //检查配置文件
        master.checkConfig();
        //开启子进程
        master.createWorker();

    },
    worker:function(){

        //导入虚拟主机配置文件
        harbors.vhost = require('../default/vhost');
        try{
            harbors.vhost = harbors.utils.merge({},require('../../../config/vhost'));
        }catch(err){
            harbors.log('User VirtualHost file not found!');
        }
        //合并虚拟主机配置文件
        worker.mergeVirtualHost();
        //创建虚拟主机路由列表
        worker.createVirtualRoute();

    }
};

module.exports = {
    cluster:app.cluster
};