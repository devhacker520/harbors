var http = require('http');
var cluster = require('cluster');
var response = require('../library/response');
var cache = require('../library/cache');

/**
 * 合并虚拟主机配置
 */
exports.mergeVirtualHost = function(){
    var config = harbors.utils.merge({},harbors.config);
    delete config.mysql;
    delete config.redis;
    delete config.listenPort;
    delete config.baseDir;
    delete config.clusterNum;
    delete config.vhost;
    if(harbors.config.vhost){
        for(var p in harbors.vhost){
            harbors.vhost[p] = harbors.utils.merge(config,harbors.vhost[p]);
        }
    }else{
        harbors.vhost = {'*':config};//读取默认配置给'*'主机
    }
};

/**
 * 创建虚拟路由
 */
exports.createVirtualRoute = function(){
    var virtualRouter = require('../library/virtualRoute');
    for(var p in harbors.vhost){
        harbors.vhost[p]['route'] = virtualRouter.extraction(harbors.vhost[p]);
    }
};

/**
 * 创建服务对象
 */
exports.createServer = function(){
    http.createServer(function(req,res){

        harbors.log('The child process to accept the request ID: #' + cluster.worker.id);

        var vhost = req.headers.host.split(":")[0];

        try{

            //选择虚拟主机
            if(!harbors.vhost[vhost]){
                if(harbors.vhost['*']){//找默认虚拟主机，如果没有的抛出错误
                    vhost = '*';
                }else{
                    harbors.err('VHOST is not found : ' + vhost);
                    response.h404(res);
                    return false;
                }
            }
            harbors.log('VHOST : ' + vhost);
            cache.check(req.headers.host+req.url,harbors.vhost[vhost],req,res,function(){
                //虚拟主机路由
                res._routeNum = 0;
                for(var i=0;i<Math.max(harbors.vhost[vhost].route.length-1,1);i++){
                    harbors.vhost[vhost].route[i](req,res,harbors.vhost[vhost]);
                }
            });


        }catch(err){

            harbors.err(err);

        }
    }).listen(harbors.config.listenPort);
};