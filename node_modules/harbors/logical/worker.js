var http = require('http');
var cluster = require('cluster');
var fs = require('fs');
var util = require('util');
var response = require('../library/response');
var cache = require('../library/cache');

/**
 * 合并虚拟主机配置
 */
exports.mergeVirtualHost = function(){
    var config = harbors.utils.merge({},harbors.config);
    delete config.mysql;
    delete config.redis;
    delete config.listenPort;
    delete config.baseDir;
    delete config.clusterNum;
    delete config.vhost;
    if(harbors.config.vhost){
        for(var p in harbors.vhost){
            harbors.vhost[p] = harbors.utils.merge(config,harbors.vhost[p]);
            if(harbors.vhost[p].debug){//开启了debug模式
                harbors.vhost[p].log = util.log;
            }else{
                harbors.vhost[p].log = function(){};
            }
        }
    }else{
        harbors.vhost = {'*':config};//读取默认配置给'*'主机
        if(harbors.vhost['*'].debug){//开启了debug模式
            harbors.vhost['*'].log = util.log;
        }else{
            harbors.vhost['*'].log = function(){};
        }
    }
};

/**
 * 创建虚拟路由
 */
exports.createVirtualRoute = function(){
    var virtualRouter = require('../library/virtualRoute');
    for(var p in harbors.vhost){
        harbors.vhost[p]['route'] = virtualRouter.extraction(harbors.vhost[p]);
    }
};

/**
 * 创建服务对象
 */
exports.createServer = function(){
    http.createServer(function(req,res){

        var vhost = req.headers.host.split(":")[0];

        try{

            //选择虚拟主机
            if(!harbors.vhost[vhost]){
                if(harbors.vhost['*']){//找默认虚拟主机，如果没有的抛出错误
                    vhost = '*';
                }else{
                    console.log('VHOST is not found : ' + vhost);
                    response.h404(res);
                    return false;
                }
            }

            cache.check(req.headers.host+req.url,harbors.vhost[vhost],req,res,function(){
                //虚拟主机路由
                res._routeNum = 0;
                for(var i=0;i<Math.max(harbors.vhost[vhost].route.length-1,1);i++){
                    harbors.vhost[vhost].route[i](req,res,harbors.vhost[vhost]);
                }
            });


        }catch(err){

            console.log(err);

        }
    }).listen(harbors.config.listenPort);
};

/**
 * 预读modules下的所有js
 */
exports.mod = function(){
    harbors.mod = {};
    fs.readdir(harbors.config.baseDir+'/modules',function(err,files){
        if(err){
            console.error(err);
        }else{
            for(var i=0;i<files.length;i++){
                if(/\.js/.test(files[i])){
                    harbors.mod[files[i].replace(/\.js/,'')] = require(harbors.config.baseDir+'/modules/'+files[i]);
                }
            }
        }
    });
}