var cluster = require('cluster');

var _sync = require('../lib/sync');
var _master = require('../lib/master');
var _worker = require('../lib/worker');

var Modular = {};

Modular.config = {};
Modular.vhost = {};
exports.config = Modular.config;
exports.vhost = Modular.vhost;

Modular.init = function(){
    if (cluster.isMaster) {
        Modular.master();
    }else{
        Modular.worker();
    }
};

Modular.master = function(){
    _sync('enhance')
        .add(function(callback){
            Modular.config = _master.mergeConfig();
            callback();
        })
        .add(function(callback){
            //检查配置文件
            _master.checkConfig(Modular.config);
            callback();
        })
        .end(function(){
            //开启子进程
            _master.createWorker(Modular.config);
        });

};

Modular.worker = function(){
    _sync('enhance')
        .add(function(callback){
            Modular.config = _worker.mergeConfig();
            callback();
        })
        .add(function(callback){
            Modular.vhost = _worker.mergeVhost(Modular.config);
            callback();
        })
        .end(function(){
            //创建服务对象
            _worker.createServer(Modular.config,Modular.vhost);
        });
};

exports.init = Modular.init;