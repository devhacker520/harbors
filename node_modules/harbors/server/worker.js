var http = require('http');
var path = require('path');
var _request_ = require('./request');
var __file__ = require('../lib/file');

exports.createServer = function(config){
    if(typeof(config.server.listen)=='string'){
        config.server.listen = [config.server.listen];
    }
    for(var i=0;i<config.server.listen.length;i++){
        http.createServer(function(req,res){
            exports.request(req,res);
        }).listen(config.server.listen[i]);
        harbors.log('子进程开始监听端口：'+config.server.listen[i]);
    }
};

exports.request = function(req,res){
    harbors.log('收到客户端请求...');
    var r = _request_(req,res);
    if(r.config==undefined){
        r.notFound();
        return undefined;
    }
    console.log(r.path)
    if(/\/$/.test(r.path.url)){//以/结尾
        var staticM = '';
        var t = r.sync('normal');
        var default_file = r.config.default_file;
        if(typeof(default_file)=='string')
            default_file = [default_file];
        default_file.map(function(a){
            t.add(function(next){
                var realFile = path.join(r.config.dir,a);
                //console.log(realFile)
                if(__file__.exists(realFile))
                    staticM = realFile;
                next();
            });
        });


        t.end(function(){
            console.log(staticM)
            var zz = new RegExp(r.config.nodejs+'$');
            console.log(zz);
            if(zz.test(staticM)){
                console.log('nodejs')
                return undefined;
            }
            zz = new RegExp(r.config.php+'$');
            console.log(zz);
            if(zz.test(staticM)){
                console.log('php')
                return undefined;
            }
        });
    }else{//不以/结尾

    }


    r._headers = {'Content-Type':'text/html; charset=utf-8'};
    r.display("index.html");
};