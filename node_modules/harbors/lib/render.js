var path = require('path');
var jade = require('jade');
/**
 * 动态jade模板渲染函数
 *
 * @param {string} file
 * @param {object} req
 * @param {object} res
 */
module.exports = function(file,obj,req,res){
    var realFile = path.normalize(harbors.config.baseDir+'/view/'+file);
    //调试流程
    console.log("jade template:"+realFile);
    if(!req.headers['if-modified-since']||((new Date()-0)-(new Date(req.headers['if-modified-since'])-0)>harbors.config.jadeTime)){
        //超出缓存时间
        jade.renderFile(realFile, obj||{}, function (err, html) {
            if (err) {
                res.writeHead(500, {'Content-Type': 'text/plain'});
                res.end("file is lost");
                console.log(err);
            }
            var lastModified = new Date().toUTCString();
            res.setHeader("Last-Modified", lastModified);
            res.writeHead(200, {'Content-Type': "text/html"});
            res.write(html, "binary");
            res.end();
        });
    }else{
        //还在jade缓存时间内
        res.writeHead(304, "Not Modified");
        res.end();
    }
};