var path = require('path');
var fs = require('fs');
var http = require('http');

var _utils = require('./utils');
var _object = require('./object');

exports.mergeConfig = function(){
    var config = require('../default/config');
    var filePath = path.normalize(config.baseDir + '/config/config');
    if(fs.existsSync(filePath+'.js')){
        config = _utils.merge(config,require(filePath));
    }else{
        console.log('User configuration file not found!');
    }
    return config;
};

exports.mergeVhost = function(config){
    var vhost = {};
    var filePath = path.normalize(config.baseDir + '/config/vhost');
    if(fs.existsSync(filePath+'.js')){
        vhost = _utils.merge(vhost,require(filePath));
    }else{
        vhost= require('../default/vhost');
        vhost = _utils.merge(vhost,require(filePath));
        console.log('User vhost file not found!');
    }
    var $config = _utils.merge({},config);
    delete $config.mysql;
    delete $config.redis;
    delete $config.listenPort;
    delete $config.baseDir;
    delete $config.clusterNum;
    delete $config.vhost;
    if(config.vhost){
        for(var p in vhost){
            vhost[p] = _utils.merge(config,vhost[p]);
        }
    }else{
        vhost = {'*':config};//读取默认配置给'*'主机
    }
    return vhost;
};

exports.createServer = function(config,hostList){
    http.createServer(function(req,res){
        if(req.url=='/favicon.ico') return false;
        console.log(req.headers.host+req.url);
        var vhost = req.headers.host.split(":")[0];
        var $object = _object(config,hostList[vhost],req,res);
        $object.cookie('test');
        $object.res.end('123');
    }).listen(config.listenPort);
};