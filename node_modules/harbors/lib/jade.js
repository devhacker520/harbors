var jade = require('jade');
var path = require('path');
var app = {
    init:function(req,res){
        this.req = req;
        this.res = res;
        return this;
    },
    render:function(file,obj){
        var vhostFile = harbors.config.vhost ? harbors.vhost[app.req.vhost]['baseDir']+'/' : '';
        var realFile = path.normalize(harbors.config.baseDir+'/view/'+vhostFile+file);
        //调试流程
        harbors.config.deBug&&console.log("显示jade模板:"+realFile);
        if(!app.req.headers['if-modified-since']||((new Date()-0)-(new Date(app.req.headers['if-modified-since'])-0)>harbors.config.jadeTime)){
            //超出缓存时间
            var lastModified = new Date().toUTCString();
            app.res.setHeader("Last-Modified", lastModified);
            jade.renderFile(realFile, obj||{}, function (err, html) {
                if (err) {
                    app.res.writeHead(500, {'Content-Type': 'text/plain'});
                    app.res.end("file is lost");
                    throw err;
                }
                app.res.writeHead(200, {'Content-Type': "text/html"});
                app.res.write(html, "binary");
                app.res.end();
            });
        }else{
            //还在jade缓存时间内
            app.res.writeHead(304, "Not Modified");
            app.res.end();
        }

    }
};

module.exports = app;