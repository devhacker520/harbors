var jade = require('jade');
var path = require('path');
var app = {
    init:function(req,res){
        this.req = req;
        this.res = res;
        return this;
    },
    render:function(file,obj){
        var vhostFile = harbors.config.vhost ? harbors.vhost[app.req.vhost]['baseDir']+'/' : '';
        var realFile = path.normalize(harbors.config.baseDir+'/view/'+vhostFile+file);
        jade.renderFile(realFile, obj||{}, function (err, html) {
            if (err) {
                app.res.writeHead(500, {'Content-Type': 'text/plain'});
                app.res.end("file is lost");
                throw err;
            }
            //客户端缓存
            var expires = new Date();
            expires.setTime(expires.getTime() + harbors.config.staticTime);
            app.res.setHeader("Expires", expires.toUTCString());
            app.res.setHeader("Cache-Control", "max-age=" + harbors.config.staticTime);
            app.res.writeHead(200, {'Content-Type': "text/html"});
            app.res.write(html, "binary");
            app.res.end();
        });
    }
};

module.exports = app