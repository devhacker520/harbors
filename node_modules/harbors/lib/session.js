var app = {
    init:function(req,res){
        this.req = req;
        this.res = res;
        return this;
    },
    Session:function(){
        if(app.req.Cookie[harbors.config.sessionId]&&harbors.session[app.req.Cookie[harbors.config.sessionId]]){
            //检查session过期时间，如果未过期则更新过期时间
            harbors.session[app.req.Cookie[harbors.config.sessionId]].update = (new Date()-0)+harbors.config.SessionSurvavil;
            return harbors.session[app.req.Cookie[harbors.config.sessionId]];
        }else{
            return {};
        }
    },
    setSession:function(session){
        function randomChar(l) {//随机字符串
            var x="123456789poiuytrewqasdfghjklmnbvcxzQWERTYUIPLKJHGFDSAZXCVBNM";
            var tmp="";
            for(var i=0;i< l;i++) {
                tmp += x.charAt(Math.ceil(Math.random()*100000000)%x.length);
            }
            return tmp;
        }
        //判断harborsid cookie是否存在
        var SessionId = '';
        if(app.req.Cookie[harbors.config.sessionId]){
            SessionId = app.req.Cookie[harbors.config.sessionId];
        }else{
            SessionId = randomChar(20);
            var cookie_t = {};
            cookie_t[harbors.config.sessionId] = SessionId;
            app.res.setCookie(cookie_t);
        }
        //如果session记录不存在
        if(!harbors.session[SessionId]){
            harbors.session[SessionId] = {};
        }
        harbors.session[SessionId].update = (new Date()-0)+harbors.config.SessionSurvavil;

        for(var p in session){
            harbors.session[SessionId][p] = session[p];
        }
        app.req.Session = harbors.session[SessionId];
    },
    delSession:function(session){
        //判断cookie存在，session存在
        if(app.req.Cookie[harbors.config.sessionId]&&harbors.session[app.req.Cookie[harbors.config.sessionId]]){
            for(var p in session){
                delete harbors.session[app.req.Cookie[harbors.config.sessionId]][p];
            }
        }
    }
};
module.exports = app;