//初始化config、vhost、cluster
global.harbors = {};
var util = require('util');

//载入工具
harbors.utils = require('./lib/utils');

//合并config
harbors.config = require('./server/config');
try{
    harbors.config = harbors.utils.merge(harbors.config,require('../../config/config'));
}catch(err){
    harbors.log('User configuration file not found!');
}

if(harbors.config.debug){
    harbors.log = util.log;
}else{
    harbors.log = function(){};
}

//导入vhost配置
if(harbors.config.vhost){
    try{
        harbors.vhost = require('../../config/vhost');
    }catch(err){
        harbors.log('User vhost file not found!');
        harbors.vhost = {'*':{}};//空vhost配置（默认会合并框架配置）
    }
}else{
    harbors.vhost = {'*':{}};//空vhost配置（默认会合并框架配置）
}

//进程集群
var cluster = require('cluster');
if (cluster.isMaster) {
    var master = require('./server/master');
    master.createWorker();
    master.checkConfig();//功能未完成
    master.checkVhost();//功能未完成
}else{
    var worker = require('./server/worker');
    worker.mergeVhost();
    worker.createRoute();
    worker.createServer();
}