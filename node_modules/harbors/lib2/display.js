var path = require('path');
var fs = require('fs');
var mime = require('./mime');
var zlib = require('zlib');

//用于返回静态文件
var app = {
    display: function (file) {//显示静态文件
        var _this = this;
        var extname = path.extname(file);
        if (!extname) {
            extname = path.extname(harbors.config.sraticFile);
            file += harbors.config.sraticFile;
        }
        var vhostFile = harbors.config.vhost ? harbors.vhost[_this.req.vhost]['baseDir'] : '';
        var realPath = path.normalize(harbors.config.baseDir + '/view/' + vhostFile + '/' + file);
        harbors.config.deBug && console.log("显示静态文件:" + realPath);
        fs.exists(realPath, function (exists) {
            if (!exists) {
                _this.res.writeHead(404, {'Content-Type': 'text/plain'});
                _this.res.end("no found file");
            } else {
                fs.stat(realPath, function (err, stat) {
                    var lastModified = stat.mtime.toUTCString();
                    var ifModifiedSince = "If-Modified-Since".toLowerCase();
                    _this.res.setHeader("Last-Modified", lastModified);

                    if (_this.req.headers[ifModifiedSince] && lastModified == _this.req.headers[ifModifiedSince]) {
                        _this.res.writeHead(304, "Not Modified");
                        _this.res.end();
                    } else {
                        if (harbors.config.gzip) {//开启了gzip
                            var raw = fs.createReadStream(realPath);
                            var acceptEncoding = _this.req.headers['accept-encoding'] || "";
                            var matched = realPath.match(harbors.config.gzipFile);
                            if (matched && acceptEncoding.match(/\bgzip\b/)) {
                                _this.res.writeHead(200, "Ok", {
                                    'Content-Encoding': 'gzip'
                                });
                                raw.pipe(zlib.createGzip()).pipe(_this.res);
                            } else if (matched && acceptEncoding.match(/\bdeflate\b/)) {
                                _this.res.writeHead(200, "Ok", {
                                    'Content-Encoding': 'deflate'
                                });
                                raw.pipe(zlib.createDeflate()).pipe(_this.res);
                            } else {
                                _this.res.writeHead(200, "Ok");
                                raw.pipe(_this.res);
                            }
                        } else {//关闭gzip
                            fs.readFile(realPath, "binary", function (err, file) {
                                if (err) {
                                    _this.res.writeHead(500, {'Content-Type': 'text/plain'});
                                    _this.res.end(err);
                                } else {//准备返回给客户端文件
                                    var expires = new Date();
                                    expires.setTime(expires.getTime() + harbors.config.staticTime);
                                    _this.res.writeHead(200, {
                                        'Content-Length': file.length,
                                        'Content-Type': mime[extname] || "text/plain",
                                        'Cache-Control': 'max-age=' + harbors.config.staticTime,
                                        "Expires": expires.toUTCString()
                                    });
                                    _this.res.write(file, "binary");
                                    _this.res.end();
                                }
                            });
                        }
                    }

                });

            }
        })
    }
};

module.exports = app;